---
name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release"
        required: true
        type: string

permissions:
  contents: write
  packages: write
  id-token: write

env:
  GO_VERSION: "1.25"
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-binaries:
    name: Build Multi-Arch Binaries
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: linux
            goarch: arm
            goarm: 7
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64
          - goos: freebsd
            goarch: amd64
          - goos: freebsd
            goarch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_short=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
          CGO_ENABLED: 0
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Determine binary name
          BINARY_NAME="github_rate_limit_exporter"
          ARCHIVE_NAME="${BINARY_NAME}-${VERSION#v}-${{ matrix.goos }}-${{ matrix.goarch }}"

          if [ -n "${{ matrix.goarm }}" ]; then
            ARCHIVE_NAME="${ARCHIVE_NAME}v${{ matrix.goarm }}"
          fi

          if [ "${{ matrix.goos }}" = "windows" ]; then
            BINARY_NAME="${BINARY_NAME}.exe"
          fi

          # Build
          mkdir -p dist
          go build -trimpath \
            -ldflags "-X main.version=${VERSION} -s -w -extldflags '-static'" \
            -o "dist/${BINARY_NAME}" \
            ./cmd/exporter

          # Create archive
          cd dist
          if [ "${{ matrix.goos }}" = "windows" ]; then
            zip "${ARCHIVE_NAME}.zip" "${BINARY_NAME}"
            echo "archive=${ARCHIVE_NAME}.zip" >> $GITHUB_OUTPUT
          else
            tar -czf "${ARCHIVE_NAME}.tar.gz" "${BINARY_NAME}"
            echo "archive=${ARCHIVE_NAME}.tar.gz" >> $GITHUB_OUTPUT
          fi

          # Generate checksums
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum ${ARCHIVE_NAME}.* > ${ARCHIVE_NAME}.sha256
          else
            shasum -a 256 ${ARCHIVE_NAME}.* > ${ARCHIVE_NAME}.sha256
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.goarm && format('-v{0}', matrix.goarm) || '' }}
          path: |
            dist/*.tar.gz
            dist/*.zip
            dist/*.sha256
          retention-days: 7

  build-docker:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: [build-binaries]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_short=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        if: secrets.DOCKERHUB_USERNAME != ''
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
            ${{ secrets.DOCKERHUB_USERNAME != '' && format('docker.io/{0}/github_rate_limit_exporter', secrets.DOCKERHUB_USERNAME) || '' }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker images
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ steps.version.outputs.version }}

      - name: Generate Docker SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version_short }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: docker-sbom
          path: sbom.spdx.json
          retention-days: 30

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-binaries, build-docker]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: binaries-*
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd artifacts
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum *.tar.gz *.zip 2>/dev/null > checksums.txt || true
          else
            shasum -a 256 *.tar.gz *.zip 2>/dev/null > checksums.txt || true
          fi

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 ${VERSION}^ 2>/dev/null || echo "")

          # Generate changelog
          if [ -n "$PREV_TAG" ]; then
            echo "## Changes since ${PREV_TAG}" > release_notes.md
            echo "" >> release_notes.md
            git log ${PREV_TAG}..${VERSION} --pretty=format:"- %s (%h)" --no-merges >> release_notes.md
          else
            echo "## Initial Release" > release_notes.md
          fi

          echo "" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Docker Images" >> release_notes.md
          echo "" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "# GitHub Container Registry" >> release_notes.md
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION#v}" >> release_notes.md
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> release_notes.md
          echo "" >> release_notes.md
          if [ -n "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
            echo "# Docker Hub" >> release_notes.md
            echo "docker pull ${{ secrets.DOCKERHUB_USERNAME }}/github_rate_limit_exporter:${VERSION#v}" >> release_notes.md
            echo "docker pull ${{ secrets.DOCKERHUB_USERNAME }}/github_rate_limit_exporter:latest" >> release_notes.md
          fi
          echo '```' >> release_notes.md
          echo "" >> release_notes.md
          echo "## Supported Platforms" >> release_notes.md
          echo "" >> release_notes.md
          echo "- Linux (amd64, arm64, armv7)" >> release_notes.md
          echo "- macOS (amd64, arm64)" >> release_notes.md
          echo "- Windows (amd64, arm64)" >> release_notes.md
          echo "- FreeBSD (amd64, arm64)" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Installation" >> release_notes.md
          echo "" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "# Download and extract (Linux amd64 example)" >> release_notes.md
          echo "wget https://github.com/${{ github.repository }}/releases/download/${VERSION}/github_rate_limit_exporter-${VERSION#v}-linux-amd64.tar.gz" >> release_notes.md
          echo "tar -xzf github_rate_limit_exporter-${VERSION#v}-linux-amd64.tar.gz" >> release_notes.md
          echo "sudo mv github_rate_limit_exporter /usr/local/bin/" >> release_notes.md
          echo '```' >> release_notes.md
          echo "" >> release_notes.md
          echo "## Verification" >> release_notes.md
          echo "" >> release_notes.md
          echo "All artifacts include SHA256 checksums. Verify with:" >> release_notes.md
          echo "" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "sha256sum -c checksums.txt" >> release_notes.md
          echo '```' >> release_notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          files: |
            artifacts/*.tar.gz
            artifacts/*.zip
            artifacts/checksums.txt
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: [create-release]
    if: ${{ !contains(github.ref, '-') }}
    steps:
      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Update Homebrew tap
        uses: mislav/bump-homebrew-formula-action@v3
        if: secrets.HOMEBREW_TAP_TOKEN != ''
        with:
          formula-name: github-rate-limit-exporter
          homebrew-tap: ${{ github.repository_owner }}/homebrew-tap
          download-url: https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/github_rate_limit_exporter-${{ steps.version.outputs.version }}-darwin-amd64.tar.gz
          commit-message: |
            {{formulaName}} {{version}}

            Automated update via GitHub Actions
        env:
          COMMITTER_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}

  notify:
    name: Notify on Release
    runs-on: ubuntu-latest
    needs: [create-release, build-docker]
    if: always()
    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        if: secrets.SLACK_WEBHOOK_URL != ''
        with:
          status: ${{ job.status }}
          text: |
            Release ${{ github.ref_name }} completed!
            Docker images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
